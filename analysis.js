// Boilerplate for reading large JSON file.
// Courtesy of https://stackoverflow.com/a/16013228
var fs = require('fs'),
    readline = require('readline'),
    stream = require('stream');

var instream = fs.createReadStream('shodan-export.json');
var outstream = new stream;
outstream.readable = true;
outstream.writable = true;

var rl = readline.createInterface({
    input: instream,
    output: outstream,
    terminal: false
});

// Reduced data.
var reduction = {};

// Process file
rl.on('line', function(line) {

    // Parse JSON line.
    var shodan = JSON.parse(line);

    // Increment institution count.
    if (shodan.org in reduction) {
        reduction[shodan.org] += 1;
    } else {
        reduction[shodan.org] = 1;
    }
});

// Report.
rl.on('close', function() {
    // Sort reduction data.
    var sortable = [];

    for (var org in reduction) {
        sortable.push({"org": org, "count": reduction[org]});
    }
    
    sortable.sort(function(a, b) {
        return b.count - a.count;
    });

    // Print sorted data.
    fs.writeFile('shodan-converted.json', JSON.stringify(sortable), 'utf8', function() {
        console.log("Written to shodan-converted.json"); 
    });
});